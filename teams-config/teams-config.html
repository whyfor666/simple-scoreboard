<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Team Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --appbar-h: 56px;
      --bg: #0b0b0b;
      --panel: #111;
      --panel-2: #161616;
      --text: #fff;
      --muted: #bbb;
      --border: #2a2a2a;
      --btn: #222;
      --btn-hover: #2c2c2c;
      --accent: #6cc0ff;
      --ok: #3bb273;
      --warn: #f2c14e;
      --err: #e74c3c;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
    }

    /* Sticky app bar (Step 1) */
    .appbar {
      position: sticky;
      top: 0;
      z-index: 1000;
      height: var(--appbar-h);
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      padding: 0 12px;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0)) ,
        var(--panel);
      border-bottom: 1px solid var(--border);
      box-shadow:
        0 2px 8px rgba(0,0,0,0.35),
        inset 0 1px 0 rgba(255,255,255,0.03);
    }
    .appbar__left {
      font-weight: 700;
      font-size: 1rem;
      letter-spacing: 0.3px;
    }
    .appbar__center {
      justify-self: center;
      font-size: 0.95rem;
      color: var(--muted);
      user-select: none;
    }
    .appbar__right {
      justify-self: end;
      display: inline-flex;
      gap: 8px;
    }
    .appbar .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 34px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--btn);
      color: var(--text);
      text-decoration: none;
      font-size: 0.92rem;
      line-height: 1;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      will-change: transform;
    }
    .appbar .btn:hover { background: var(--btn-hover); border-color: #3a3a3a; }
    .appbar .btn:active { transform: translateY(1px) scale(0.995); }

    .page { padding: 16px; }

    /* Control Card (Step 2) — styled like your HR Animations “control tile” */
    .control-card {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
      padding: 14px 16px;
      border-radius: 14px;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0)),
        var(--panel-2);
      border: 1px solid var(--border);
      box-shadow: 0 8px 24px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.04);
      margin-bottom: 16px;
    }
    .control-left {
      display: grid;
      gap: 6px;
    }
    .control-title {
      font-weight: 700;
      letter-spacing: 0.3px;
      font-size: 1rem;
    }
    .metrics {
      display: grid;
      grid-template-columns: repeat(3, auto);
      gap: 14px;
      align-items: baseline;
      font-size: 0.95rem;
    }
    .metric .label { color: var(--muted); font-size: 0.88rem; }
    .metric .value { font-variant-numeric: tabular-nums; }
    .value.ok { color: var(--ok); }
    .value.warn { color: var(--warn); }
    .value.err { color: var(--err); }

    .control-right {
      display: inline-flex;
      gap: 8px;
      justify-self: end;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 36px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--btn);
      color: var(--text);
      text-decoration: none;
      font-size: 0.92rem;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
    }
    .btn:hover { background: var(--btn-hover); border-color: #3a3a3a; }
    .btn:active { transform: translateY(1px) scale(0.995); }

    /* Existing harmonized styles */
    input, button {
      font-size: 1rem;
      padding: 0.5rem 0.7rem;
      margin-top: 0.5rem;
      background: var(--btn);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    button:hover { background: var(--btn-hover); }
    .button-row { margin-top: 1rem; } /* (Not used now; kept in case you revert) */

    #teamsList{
    display:grid;
    grid-template-columns:repeat(5, minmax(220px, 1fr));
    gap:10px;
    justify-items:stretch;
    }
    @media (max-width:1100px){
    #teamsList{ grid-template-columns:repeat(4, minmax(220px,1fr)); }
    }
    @media (max-width:880px){
    #teamsList{ grid-template-columns:repeat(3, minmax(220px,1fr)); }
    }

    .team-entry {
      padding: 1rem;
      margin: 0.25rem;
      border-radius: 12px;
      box-sizing: border-box;
      width: 250px;
      flex: 0 0 auto;
      background: var(--panel-2);
      border: 1px solid var(--border);
    }

    .team-entry img, .team-entry .placeholder-box {
      width: 100px;
      height: 100px;
      display: block;
      margin: 0.5rem auto 0;
      border: 1px solid;
      border-radius: 10px;
      background: #00000020;
    }
    .team-entry img { object-fit: contain; }

    .placeholder-box {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      text-align: center;
      white-space: nowrap;
      line-height: 100px;
    }

    #storageUsage { margin-top: 1rem; }

    /* Modal */
    #modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(2px);
    }
    #modal .modal-content {
      background: #222;
      color: white;
      padding: 1rem 1.25rem;
      border-radius: 12px;
      max-width: 320px;
      margin: auto;
      text-align: center;
      position: relative;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    #modal.warning .modal-content { background-color: #5a3f00; }
    #modal.info .modal-content { background-color: #0f3555; }
    #modal.error .modal-content { background-color: #551010; }
    #modalIcon { font-size: 2rem; margin-bottom: 0.35rem; }

    h1, h2 { margin: 0.5rem 0 0.75rem; }
    form label { display: inline-block; margin-top: 0.4rem; }
  </style>
</head>
<body>
  <!-- App Bar -->
  <header class="appbar">
    <div class="appbar__left">Team Settings</div>
    <div class="appbar__center">tap to edit</div>
    <div class="appbar__right">
      <a class="btn" href="./hr-animations.html" title="Open HR Animations">HR Animations</a>
      <a class="btn" href="./index.html" title="Open Scoreboard">Scoreboard</a>
    </div>
  </header>

  <div class="page">
    <!-- Control Card (KB metrics + Export/Import) -->
    <section class="control-card" id="controlCard" aria-label="Storage and tools">
      <div class="control-left">
        <div class="control-title">Storage & Tools</div>
        <div class="metrics">
          <div class="metric">
            <div class="label">Teams</div>
            <div class="value" id="teamsKB">0.00 KB</div>
          </div>
          <div class="metric">
            <div class="label">Animations</div>
            <div class="value" id="animsKB">0.00 KB</div>
          </div>
          <div class="metric">
            <div class="label">Overall Used</div>
            <div class="value" id="overallKB">0.00 KB</div>
          </div>
        </div>
      </div>
      <div class="control-right">
        <button class="btn" id="exportBtn" title="Export teams JSON">Export</button>
        <input type="file" id="importFile" accept="application/json" style="display:none">
        <button class="btn" type="button" id="importBtn" title="Import teams JSON">Import</button>
      </div>
    </section>

    <!-- Original Form / List -->
    <form id="teamForm">
      <label>Team Name:<br> <input type="text" id="teamName" placeholder="e.g., Tigers"></label><br>
      <label>Team Color:<br> <input type="color" id="teamColor" value="#2b2b2b"></label><br>
      <label>Team Logo:<br> <input type="file" id="teamLogo" accept="image/*"></label><br>
      <button type="submit">Add/Update Team</button>
    </form>

    <h2>Saved Teams</h2>
    <div id="storageUsage"></div>
    <div id="teamsList"></div>
  </div>

  <!-- Modal -->
  <div id="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div id="modalIcon">⚠️</div>
      <p id="modalMessage"></p>
      <button onclick="closeModal()">OK</button>
    </div>
  </div>

  <script>
    let teams = JSON.parse(localStorage.getItem('teams') || '[]');

    let editingIndex = -1;

    function normalizeName(s) {
    return (s || '')
        .normalize('NFKC')
        .trim()
        .replace(/\s+/g, ' ')
        .toLowerCase();
    }

    let modalTimeout = null;
   
    function showModal(message, icon = '⚠️') {
      const modal = document.getElementById('modal');
      const content = modal.querySelector('.modal-content');
      modal.className = 'modal';
      content.className = 'modal-content';

      if (icon === '⚠️') modal.classList.add('warning');
      else if (icon === 'ℹ️') modal.classList.add('info');
      else if (icon === '❌') modal.classList.add('error');

      document.getElementById('modalMessage').innerHTML = message.replace(/\\n/g, '<br>');
      document.getElementById('modalIcon').textContent = icon;
      modal.style.display = 'flex';
      clearTimeout(modalTimeout);
      modalTimeout = setTimeout(closeModal, 5000);
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    function byteSize(str) {
      return new TextEncoder().encode(str).length;
    }
    function fmtKB(bytes) {
      return (bytes / 1024).toFixed(2) + ' KB';
    }

    function saveTeams() {
      try {
        localStorage.setItem('teams', JSON.stringify(teams));
      } catch (e) {
        showModal('Storage full. 5MB max.\\nTry removing large logos or reducing image size.', '❌');
      }
    }

    function getContrastColor(hex = '#2b2b2b') {
      const r = parseInt(hex.substr(1, 2), 16) || 0;
      const g = parseInt(hex.substr(3, 2), 16) || 0;
      const b = parseInt(hex.substr(5, 2), 16) || 0;
      const brightness = (r * 299 + g * 587 + b * 114) / 1000;
      return brightness > 125 ? 'black' : 'white';
    }

    /* ---- Storage metrics (Step 2) ---- */

    // Known/likely keys used by your HR Animations module. Extend if needed.
    const ANIM_KEYS = [
      'hrAnimations', 'hrAnimationsData', 'hrAnimationsConfig', 'hrAnimationRows',
      'animations', 'hr-animations', 'hrThumbs', 'hrEditorState'
    ];

    function calcTeamsBytes() {
      // Sum each team entry for a closer-to-UI readout (matches the per-tile “Size”)
      try {
        return teams.reduce((sum, t) => sum + byteSize(JSON.stringify(t)), 0);
      } catch { return 0; }
    }

    function calcAnimationsBytes() {
      let total = 0;
      for (const key of ANIM_KEYS) {
        const v = localStorage.getItem(key);
        if (v != null) total += byteSize(v);
      }
      return total;
    }

    function calcLocalStorageBytes() {
      // Entire localStorage payload (keys + values)
      let total = 0;
      for (let i = 0; i < localStorage.length; i++) {
        const k = localStorage.key(i);
        const v = localStorage.getItem(k);
        total += byteSize(k) + byteSize(v || '');
      }
      return total;
    }

    function colorizeOverall(bytes) {
      // Rough thresholds vs 5MB limit
      const el = document.getElementById('overallKB');
      el.classList.remove('ok', 'warn', 'err');
      const ratio = bytes / (5 * 1024 * 1024);
      if (ratio < 0.6) el.classList.add('ok');
      else if (ratio < 0.85) el.classList.add('warn');
      else el.classList.add('err');
    }

    function updateControlCard() {
      const teamsBytes = calcTeamsBytes();
      const animBytes  = calcAnimationsBytes();
      const allBytes   = calcLocalStorageBytes();

      document.getElementById('teamsKB').textContent   = fmtKB(teamsBytes);
      document.getElementById('animsKB').textContent   = fmtKB(animBytes);
      document.getElementById('overallKB').textContent = fmtKB(allBytes) + ' / ~5120 KB';
      colorizeOverall(allBytes);
    }

    /* ---- Teams list/UI ---- */

    function renderTeams() {
        const container = document.getElementById('teamsList');
        const storageDisplay = document.getElementById('storageUsage');
        container.innerHTML = '';
        let totalBytes = 0;

        // render real teams
        teams.forEach((team, index) => {
        const teamData = JSON.stringify(team);
        const size = byteSize(teamData);
        totalBytes += size;
        const bg = team.color || '#1f1f1f';
        const textColor = getContrastColor(bg);

        const div = document.createElement('div');
        div.className = 'team-entry';
        div.style.backgroundColor = bg;
        div.style.color = textColor;

        const imageOrPlaceholder = team.logo
        ? `<img src="${team.logo}" alt="Logo" style="border-color:${textColor}">`
        : `<div class="placeholder-box" style="border-color:${textColor}">No file selected.</div>`;

        div.innerHTML = ` 
        <strong>${team.name || 'Untitled Team'}</strong><br>
        Color: <span>${bg}</span><br>
        ${imageOrPlaceholder}<br>
        Size: ${(size / 1024).toFixed(2)} KB<br>
    <!--   <button onclick="event.stopPropagation(); deleteTeam(${index})">Delete</button> -->
    <!--   <button onclick="event.stopPropagation(); editTeam(${index})">Edit</button> -->
        `;

        // tap/click anywhere on the card to edit (matches “tap to edit” in app bar)
        div.addEventListener('click', () => editTeam(index));
        container.appendChild(div);
        });

        // add placeholders up to 14
        const totalSlots = 14;
        const toAdd = Math.max(0, totalSlots - teams.length);
        for (let i = 0; i < toAdd; i++) {
            const div = document.createElement('div');
            div.className = 'team-entry';
            div.style.backgroundColor = 'var(--panel-2)';
            div.innerHTML = `
            <strong>Empty slot</strong><br>
            <span class="placeholder-box" style="border-color:var(--border)">Tap to add</span><br>
            <button onclick="event.stopPropagation(); /* focuses form */ document.getElementById('teamName').focus();">Add</button>
            `;
            // clicking the tile focuses the add form
            div.addEventListener('click', () => document.getElementById('teamName').focus());
            container.appendChild(div);
        }

        storageDisplay.innerHTML = `<p>Total Storage Used (teams only): ${(totalBytes / 1024).toFixed(2)} KB</p>`;
        updateControlCard();
        
    }

    function deleteTeam(index) {
    teams.splice(index, 1);
    if (editingIndex === index) editingIndex = -1;
    saveTeams();
    renderTeams();
    }

    function editTeam(index) {
    const team = teams[index];
    editingIndex = index; // track which row we are editing
    document.getElementById('teamName').value  = team.name || '';
    document.getElementById('teamColor').value = team.color || '#2b2b2b';
    document.getElementById('teamLogo').value  = ''; // file inputs cannot be prefilled
    showModal(
        'Edit values loaded for: ' +
        '<strong>' + (team.name || 'Untitled Team') + '</strong>' +
        '\n\nLogo must be re-selected if changed.',
        'ℹ️'
    );
    }

    document.getElementById('teamForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const name  = document.getElementById('teamName').value.trim();
    const color = document.getElementById('teamColor').value || '#2b2b2b';
    const file  = document.getElementById('teamLogo').files[0];

    if (!name) return showModal('Team name required', '⚠️');

    const norm = normalizeName(name);

    // Find a conflicting row *other than the one we're editing*
    const conflictIndex = teams.findIndex((t, i) =>
        normalizeName(t.name) === norm && i !== editingIndex
    );
    if (conflictIndex !== -1) {
        return showModal(`A team named "${teams[conflictIndex].name}" already exists.`, '⚠️');
    }

  const finalize = (logoBase64) => {
    const teamData = { name, color, logo: logoBase64 || null };

    if (editingIndex >= 0) {
      teams[editingIndex] = teamData;      // update same row
    } else {
      teams.push(teamData);                 // add new
    }

    saveTeams();
    renderTeams();
    editingIndex = -1;                      // exit edit mode
    document.getElementById('teamForm').reset();
  };

  if (file) {
    if (file.size > 2 * 1024 * 1024) return showModal('Please upload images smaller than 2MB.', '⚠️');
    const reader = new FileReader();
    reader.onload = () => finalize(reader.result);
    reader.readAsDataURL(file);
  } else {
    // Keep existing logo when editing; null for new rows
    const currentLogo = editingIndex >= 0 ? (teams[editingIndex].logo || null) : null;
    finalize(currentLogo);
  }
});


    // Control card: Export/Import
    document.getElementById('exportBtn').addEventListener('click', () => {
      const data = JSON.stringify(teams);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'teams-backup.json';
      a.click();
    });

    document.getElementById('importBtn').addEventListener('click', () => {
      document.getElementById('importFile').click();
    });

    document.getElementById('importFile').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          if (!Array.isArray(parsed)) throw new Error();
          teams = parsed;
          saveTeams();
          renderTeams();
        } catch (e) {
          showModal('Invalid file format.\\nMake sure you uploaded a valid teams-backup.json file.', '❌');
        }
      };
      reader.readAsText(file);
      // reset input so selecting the same file again will still trigger
      event.target.value = '';
    });

    // Update totals when other tabs windows change localStorage
    window.addEventListener('storage', updateControlCard);

    // Initial render
    renderTeams();
  </script>
</body>
</html>
