<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team Settings</title>
  <link rel="stylesheet" href="teams-config.css" />
  <style>
    /* Fallback tokens in case the external CSS misses any */
    :root{
      --panel-1:#1e1e1e; --panel-2:#262626; --border:#333; --text:#eaeaea; --accent:#3a86ff;
    }
    body{ margin:0; background:#111; color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif; }

    /* App bar */
    .appbar{
      position:sticky; top:0; z-index:5; display:flex; align-items:center; gap:12px;
      padding:14px 16px; background:var(--panel-1); border-bottom:1px solid var(--border);
    }
    .appbar .title{ font-weight:700; }
    .appbar .center{ margin-left:auto; margin-right:auto; opacity:.8; font-size:.95rem; }
    .appbar .actions{ display:flex; gap:8px; }
    .btn{
      height:36px; padding:0 12px; border-radius:10px; border:1px solid var(--border);
      background:var(--panel-2); color:inherit; cursor:pointer;
    }
    .btn.primary{ background:var(--accent); border-color:transparent; color:#fff; }
    .container{ max-width:1200px; margin:16px auto; padding:0 12px; }

    /* Grid */
    .teams-grid{
      display:grid; grid-template-columns:repeat(5, minmax(220px, 1fr));
      gap:10px; justify-items:stretch;
    }
    @media (max-width:1100px){ .teams-grid{ grid-template-columns:repeat(4, minmax(220px,1fr)); } }
    @media (max-width:880px){  .teams-grid{ grid-template-columns:repeat(3, minmax(220px,1fr)); } }

    /* Cards (teams + control tile share the same look) */
    .team-entry{
      display:flex; flex-direction:column; gap:8px; padding:12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.08); user-select:none; min-height:200px;
      background:var(--panel-1);
    }
    .team-entry strong{ font-size:1.05rem; }
    .team-entry img{
      max-width:100%; max-height:140px; object-fit:contain;
      display:block; margin-top:4px; border:2px solid currentColor; border-radius:10px;
    }
    .team-entry .placeholder-box{
      display:grid; place-items:center; height:140px;
      border:2px dashed currentColor; border-radius:10px; opacity:.85;
    }
    .entry-actions{ margin-top:auto; display:flex; gap:8px; }
    .entry-actions .btn{ height:34px; }

    /* Control tile tweaks */
    .team-entry.control{ cursor:default; }
    .kb-list{ display:grid; gap:6px; }
    .kb-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .kb-row.total{ padding-top:6px; border-top:1px dashed var(--border); font-weight:600; }

    /* Modal (full styles live in teams-config.css; these are safe fallbacks) */
    .modal.hidden{ display:none; }
    .modal{ position:fixed; inset:0; z-index:1000; display:flex; align-items:center; justify-content:center;
            background:rgba(0,0,0,.5); backdrop-filter:saturate(120%) blur(2px); }
    .modal-card{ width:min(900px, 92vw); background:var(--panel-1); color:var(--text);
                 border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.4); overflow:hidden; }
    .modal-header, .modal-footer{ display:flex; align-items:center; gap:12px; padding:14px 16px; }
    .modal-header{ border-bottom:1px solid var(--border); }
    .modal-footer{ border-top:1px solid var(--border); }
    .modal-body{ padding:16px; }
    .editor-grid{ display:grid; grid-template-columns:1fr 1.2fr; gap:16px; }
    @media (max-width:900px){ .editor-grid{ grid-template-columns:1fr; } }
    .status-pill{ margin-left:auto; font-size:.85rem; padding:4px 10px; border-radius:999px; border:1px solid var(--border); }
    .status-pill.saved{ background:rgba(0,128,0,.15); }
    .status-pill.unsaved{ background:rgba(255,165,0,.15); }
    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .field input[type="text"], .field input[type="color"]{
      height:40px; border:1px solid var(--border); border-radius:10px; background:var(--panel-2); color:inherit; padding:0 12px; outline:none;
    }
    .team-entry.preview{ min-height:220px; border:1px dashed var(--border); }
  </style>
</head>
<body>
  <!-- App Bar -->
  <div class="appbar">
    <div class="title">Team Settings</div>
    <div class="center">Tap a Team to Edit</div>
    <div class="actions">
      <button class="btn" id="navAnimations">HR Animations</button>
      <button class="btn" id="navScoreboard">Scoreboard</button>
    </div>
  </div>

  <div class="container">
    <!-- Teams Grid (control tile will be slot #1) -->
    <section>
      <div id="teamsList" class="teams-grid"></div>
    </section>
  </div>

  <!-- Team Editor Modal -->
  <div id="teamEditorModal" class="modal hidden" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="teamEditorTitle">
      <header class="modal-header">
        <h3 id="teamEditorTitle">Team Editor</h3>
        <span id="editStatus" class="status-pill saved">Saved</span>
      </header>

      <div class="modal-body">
        <div class="editor-grid">
          <form id="teamEditForm" autocomplete="off">
            <label class="field">
              <span>Name</span>
              <input id="editName" type="text" placeholder="Team name" required />
            </label>

            <label class="field">
              <span>Color</span>
              <input id="editColor" type="color" value="#2b2b2b" />
            </label>

            <label class="field">
              <span>Logo</span>
              <input id="editLogo" type="file" accept="image/*" />
            </label>
          </form>

          <!-- Live Preview Card -->
          <div id="teamPreview" class="team-entry preview"></div>
        </div>
      </div>

      <footer class="modal-footer">
        <button id="btnReset" class="btn" disabled>Reset</button>
        <div class="flex-spacer" style="flex:1;"></div>
        <button id="btnCancel" class="btn">Cancel</button>
        <button id="btnSave" class="btn primary" disabled>Save</button>
      </footer>
    </div>
  </div>

  <script>
    // ---------- Utilities ----------
    const TEAMS_KEY = 'teams';

    function byteSize(str){ return new Blob([str || '']).size; }
    function formatKB(bytes){ return (bytes/1024).toFixed(2) + ' KB'; }

    function getContrastColor(hex){
      const c = (hex || '#000').replace('#','');
      const v = c.length===3 ? c.split('').map(x=>x+x).join('') : c.padEnd(6,'0');
      const r = parseInt(v.substr(0,2),16), g=parseInt(v.substr(2,2),16), b=parseInt(v.substr(4,2),16);
      const lum = (0.299*r + 0.587*g + 0.114*b)/255;
      return lum > 0.57 ? '#000' : '#fff';
    }

    function normalizeName(s){
      return (s || '').normalize('NFKC').trim().replace(/\s+/g,' ').toLowerCase();
    }

    // ---------- Data ----------
    let teams = [];
    let editingIndex = -1;           // -1 means adding
    let originalTeamSnapshot = null; // {name,color,logo}
    let pendingLogoDataURL = null;   // preview before save

    function loadTeams(){
      try{
        const raw = localStorage.getItem(TEAMS_KEY);
        teams = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(teams)) teams = [];
      }catch(e){ teams = []; }
    }
    function saveTeams(){
      localStorage.setItem(TEAMS_KEY, JSON.stringify(teams));
      updateControlCard();
    }

    // ---------- Storage Counters ----------
    function calcTeamsBytes(){ return byteSize(localStorage.getItem(TEAMS_KEY)); }
    function calcAnimationsBytes(){
      let sum = 0;
      for (const k of Object.keys(localStorage)){
        const low = k.toLowerCase();
        if (low.includes('anim')) sum += byteSize(localStorage.getItem(k));
      }
      return sum;
    }
    function calcOverallBytes(){
      let sum = 0;
      for (const k of Object.keys(localStorage)) sum += byteSize(localStorage.getItem(k));
      return sum;
    }
    function updateControlCard(){
      const akb = document.getElementById('animationsKB');
      const tkb = document.getElementById('teamsKB');
      const okb = document.getElementById('overallKB');
      if (!akb || !tkb || !okb) return; // tile not rendered yet
      akb.textContent = formatKB(calcAnimationsBytes());
      tkb.textContent = formatKB(calcTeamsBytes());
      okb.textContent = formatKB(calcOverallBytes());
    }

    // ---------- Render ----------
    function renderTeams(){
      const container = document.getElementById('teamsList');
      container.innerHTML = '';

      // (A) Control tile as FIRST slot
      const control = document.createElement('div');
      control.className = 'team-entry control';
      control.innerHTML = `
        <strong>Storage &amp; Tools</strong>
        <div class="kb-list">
          <div class="kb-row"><span>Animations Storage</span><span id="animationsKB">0 KB</span></div>
          <div class="kb-row"><span>Teams Storage</span><span id="teamsKB">0 KB</span></div>
          <div class="kb-row total"><span>Overall LocalStorage</span><span id="overallKB">0 KB</span></div>
        </div>
        <div class="entry-actions">
          <button class="btn" id="btnExport">Export</button>
          <button class="btn" id="btnImport">Import</button>
          <input type="file" id="importFile" accept="application/json" hidden>
        </div>
      `;
      container.appendChild(control);

      // (B) Real team tiles
      teams.forEach((team, index) => {
        const bg = team.color || '#1f1f1f';
        const textColor = getContrastColor(bg);
        const sizeKB = formatKB(byteSize(JSON.stringify(team)));

        const div = document.createElement('div');
        div.className = 'team-entry';
        div.style.backgroundColor = bg;
        div.style.color = textColor;

        const imageOrPlaceholder = team.logo
          ? `<img src="${team.logo}" alt="Logo" style="border-color:${textColor}">`
          : `<div class="placeholder-box" style="border-color:${textColor}">No file selected.</div>`;

        div.innerHTML = `
          <strong>${team.name || 'Untitled Team'}</strong>
          <div>Color: <span>${bg}</span></div>
          <div>Size: <span>${sizeKB}</span></div>
          ${imageOrPlaceholder}
          <div class="entry-actions">
            <button class="btn" data-action="delete">Delete</button>
            <button class="btn" data-action="edit">Edit</button>
          </div>
        `;

        div.addEventListener('click', (e) => {
          const action = (e.target && e.target.dataset && e.target.dataset.action) || '';
          if (action === 'delete'){
            e.stopPropagation();
            if (confirm('Delete this team?')) deleteTeam(index);
            return;
          }
          openTeamEditor(index);
        });

        container.appendChild(div);
      });

      // (C) Placeholders to reach 14 TEAM slots (total grid = 1 control + up to 14 teams = 15 tiles)
      const TEAM_SLOTS = 14;
      const toAdd = Math.max(0, TEAM_SLOTS - teams.length);
      for (let i=0;i<toAdd;i++){
        const div = document.createElement('div');
        div.className = 'team-entry';
        div.style.backgroundColor = 'var(--panel-2)';
        div.style.color = 'var(--text)';
        div.innerHTML = `
          <strong>Empty slot</strong>
          <div class="placeholder-box" style="border-color:var(--border)">Tap to add</div>
          <div class="entry-actions">
            <button class="btn" data-action="add">Add</button>
          </div>
        `;
        div.addEventListener('click', () => openTeamEditor(-1));
        container.appendChild(div);
      }

      // Update counters and wire the control tile’s buttons
      updateControlCard();
      wireControlTile();
    }

    function wireControlTile(){
      const exportBtn = document.getElementById('btnExport');
      const importBtn = document.getElementById('btnImport');
      const importFile = document.getElementById('importFile');
      if (!exportBtn || !importBtn || !importFile) return;

      exportBtn.onclick = exportTeams;
      importBtn.onclick = () => importFile.click();
      importFile.onchange = (e) => {
        const f = e.target.files[0];
        if (f) importTeamsFromFile(f);
        e.target.value = '';
      };
    }

    function deleteTeam(index){
      teams.splice(index,1);
      if (editingIndex === index) editingIndex = -1;
      saveTeams();
      renderTeams();
    }

    // ---------- Modal Editor ----------
    function getCurrentEditValues(){
      return {
        name: document.getElementById('editName').value.trim(),
        color: document.getElementById('editColor').value || '#2b2b2b',
        logo: pendingLogoDataURL != null
          ? pendingLogoDataURL
          : (originalTeamSnapshot ? originalTeamSnapshot.logo : null)
      };
    }

    function renderPreview(team){
      const preview = document.getElementById('teamPreview');
      const bg = team.color || '#2b2b2b';
      const textColor = getContrastColor(bg);
      preview.style.backgroundColor = bg;
      preview.style.color = textColor;

      const imageOrPlaceholder = team.logo
        ? `<img src="${team.logo}" alt="Logo">`
        : `<div class="placeholder-box">No file selected.</div>`;

      preview.innerHTML = `
        <strong>${team.name || 'Untitled Team'}</strong>
        ${imageOrPlaceholder}
      `;
    }

    function updateDirtyState(){
      const cur = getCurrentEditValues();
      const was = originalTeamSnapshot || { name:'', color:'#2b2b2b', logo:null };
      const dirty = (
        normalizeName(cur.name) !== normalizeName(was.name) ||
        (cur.color || '') !== (was.color || '') ||
        (cur.logo || '')  !== (was.logo  || '')
      );
      const pill = document.getElementById('editStatus');
      pill.classList.toggle('unsaved', dirty);
      pill.classList.toggle('saved', !dirty);
      pill.textContent = dirty ? 'Unsaved' : 'Saved';
      document.getElementById('btnSave').disabled  = !dirty;
      document.getElementById('btnReset').disabled = !dirty;
    }

    function openTeamEditor(index){
      editingIndex = index; // -1 => adding new
      const t = (index >= 0 && teams[index]) ? teams[index] : { name:'', color:'#2b2b2b', logo:null };
      originalTeamSnapshot = { name: t.name || '', color: t.color || '#2b2b2b', logo: t.logo || null };
      pendingLogoDataURL = null;

      document.getElementById('editName').value  = originalTeamSnapshot.name;
      document.getElementById('editColor').value = originalTeamSnapshot.color;
      document.getElementById('editLogo').value  = '';

      document.getElementById('teamEditorModal').classList.remove('hidden');
      renderPreview(getCurrentEditValues());
      updateDirtyState();

      setTimeout(()=>document.getElementById('editName').focus(), 0);
    }

    function closeTeamEditor(){
      document.getElementById('teamEditorModal').classList.add('hidden');
      editingIndex = -1;
      originalTeamSnapshot = null;
      pendingLogoDataURL = null;
    }

    // ---------- Export / Import ----------
    function exportTeams(){
      const data = JSON.stringify(teams, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url  = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'teams-export.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importTeamsFromFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const arr = JSON.parse(reader.result);
          if (!Array.isArray(arr)) throw new Error('Invalid format');
          const cleaned = arr.map(t => ({
            name: (t && t.name) ? String(t.name) : '',
            color: (t && t.color) ? String(t.color) : '#2b2b2b',
            logo: (t && t.logo) ? String(t.logo) : null
          }));
          teams = cleaned;
          saveTeams();
          renderTeams();
          alert('Import complete.');
        }catch(err){
          alert('Import failed: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    // ---------- App init & listeners ----------
    document.addEventListener('DOMContentLoaded', () => {
      // nav buttons (adjust paths as needed)
      document.getElementById('navAnimations').addEventListener('click', () => {
        // window.location.href = './hr-animations.html';
      });
      document.getElementById('navScoreboard').addEventListener('click', () => {
        // window.location.href = './index.html';
      });

      loadTeams();
      renderTeams(); // builds control tile, teams, placeholders, counters

      // Modal input listeners
      const nameEl  = document.getElementById('editName');
      const colorEl = document.getElementById('editColor');
      const logoEl  = document.getElementById('editLogo');
      const btnCancel = document.getElementById('btnCancel');
      const btnReset  = document.getElementById('btnReset');
      const btnSave   = document.getElementById('btnSave');

      nameEl.addEventListener('input', () => { renderPreview(getCurrentEditValues()); updateDirtyState(); });
      colorEl.addEventListener('input', () => { renderPreview(getCurrentEditValues()); updateDirtyState(); });
      logoEl.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file){ pendingLogoDataURL = null; renderPreview(getCurrentEditValues()); updateDirtyState(); return; }
        if (file.size > 2 * 1024 * 1024){ alert('Please upload images smaller than 2MB.'); e.target.value = ''; return; }
        const reader = new FileReader();
        reader.onload = () => { pendingLogoDataURL = reader.result; renderPreview(getCurrentEditValues()); updateDirtyState(); };
        reader.readAsDataURL(file);
      });

      btnCancel.addEventListener('click', () => { closeTeamEditor(); });
      btnReset.addEventListener('click', () => {
        if (!originalTeamSnapshot) return;
        nameEl.value  = originalTeamSnapshot.name || '';
        colorEl.value = originalTeamSnapshot.color || '#2b2b2b';
        logoEl.value  = '';
        pendingLogoDataURL = null;
        renderPreview(getCurrentEditValues());
        updateDirtyState();
      });
      btnSave.addEventListener('click', () => {
        const { name, color, logo } = getCurrentEditValues();
        if (!name){ alert('Team name required'); return; }

        const norm = normalizeName(name);
        const conflictIndex = teams.findIndex((t, i) => normalizeName(t.name) === norm && i !== editingIndex);
        if (conflictIndex !== -1){
          alert(`A team named "${teams[conflictIndex].name}" already exists.`);
          return;
        }

        if (editingIndex >= 0){
          teams[editingIndex] = { name, color, logo: logo || null };
        }else{
          teams.push({ name, color, logo: logo || null });
        }
        saveTeams();
        renderTeams();
        closeTeamEditor();
      });

      // ESC to close, Ctrl/Cmd+Enter to save
      document.addEventListener('keydown', (e) => {
        const modalOpen = !document.getElementById('teamEditorModal').classList.contains('hidden');
        if (!modalOpen) return;
        if (e.key === 'Escape'){ e.preventDefault(); closeTeamEditor(); }
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)){
          e.preventDefault();
          if (!document.getElementById('btnSave').disabled) document.getElementById('btnSave').click();
        }
      });
    });
  </script>
</body>
</html>
